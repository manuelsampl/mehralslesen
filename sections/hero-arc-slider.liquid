{% liquid
  assign selected_collection = collections[section.settings.collection]
  assign products = selected_collection.products | default: empty
  assign total = products.size
%}

<section
  id="ArcCarousel-{{ section.id }}"
  class="arc-carousel color-{{ section.settings.color_scheme }} section-wrapper"
>
  <div class="arc-carousel__inner {{ section.settings.section_width }}">
    <div
      class="arc-carousel__stage"
      style="--arc-color: {{ section.settings.arc_color }}; --arc-height: {{ section.settings.arc_height }}vh; --item-max: 6;"
    >
      <div class="arc-carousel__rail" data-items>
        {%- if selected_collection and total > 0 -%}
          {%- for product in products -%}
            {% comment %} Hide products with price of 0 {% endcomment %}
            {% unless product.price == 0 %}
              {%- liquid
                assign media_bg_class = ''
                if product.tags contains 'primarstufe'
                  assign media_bg_class = 'arc-card__media--primarstufe'
                elsif product.tags contains 'sekundarstufe'
                  assign media_bg_class = 'arc-card__media--sekundarstufe'
                endif
              -%}
              <a href="{{ product.url }}" class="arc-item" data-index="{{ forloop.index0 }}">
              <div class="arc-card">
                <div class="arc-card__media {{ media_bg_class }}">
                  {%- if product.featured_image -%}
                    {%- assign img = product.featured_image -%}
                    {{
                      img
                      | image_url: width: 800
                      | image_tag: alt: product.title, loading: 'lazy', class: 'arc-card__img'
                    }}
                  {%- else -%}
                    {{ 'image' | placeholder_svg_tag: 'arc-card__img placeholder' }}
                  {%- endif -%}
                </div>
                <div class="arc-card__meta">
                  <div class="arc-card__title">{{ product.title }}</div>
                  {%- if product.price -%}
                    <div class="arc-card__price">{{ product.price | money }}</div>
                  {%- endif -%}
                </div>
              </div>
            </a>
            {% endunless %}
          {%- endfor -%}
        {%- else -%}
          {%- for i in (1..10) -%}
            <div class="arc-item" aria-hidden="true">
              <div class="arc-card">
                <div class="arc-card__media">
                  {{ 'product-apparel-1' | placeholder_svg_tag: 'arc-card__img placeholder' }}
                </div>
                <div class="arc-card__meta">
                  <div class="arc-card__title">{{ 'onboarding.product_title' | t }}</div>
                </div>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>

      <button class="arc-nav arc-nav--prev" type="button" aria-label="{{ 'general.previous' | t }}" data-prev>
        <svg xmlns="http://www.w3.org/2000/svg" width="69.428" height="37.894" viewBox="0 0 69.428 37.894">
          <g id="Gruppe_78" data-name="Gruppe 78" transform="translate(2.5 3.518)">
            <g id="Gruppe_50" data-name="Gruppe 50" transform="translate(44.508 30.858) rotate(-90)">
              <line id="Linie_18" data-name="Linie 18" x1="15.429" y2="18.902" transform="translate(15.429)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
              <line id="Linie_19" data-name="Linie 19" x2="15.429" y2="18.902" transform="translate(0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
            </g>
            <g id="Gruppe_51" data-name="Gruppe 51" transform="translate(0 15.429)">
              <line id="Linie_20" data-name="Linie 20" x1="63.41" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
            </g>
          </g>
        </svg>
      </button>
      <button class="arc-nav arc-nav--next" type="button" aria-label="{{ 'general.next' | t }}" data-next>
        <svg xmlns="http://www.w3.org/2000/svg" width="69.428" height="37.893" viewBox="0 0 69.428 37.893">
          <g id="Gruppe_78" data-name="Gruppe 78" transform="translate(2.5 3.518)">
            <g id="Gruppe_50" data-name="Gruppe 50" transform="translate(63.41 0) rotate(90)">
              <line id="Linie_18" data-name="Linie 18" x1="15.429" y1="18.902" transform="translate(15.429 0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
              <line id="Linie_19" data-name="Linie 19" y1="18.902" x2="15.429" transform="translate(0 0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
            </g>
            <g id="Gruppe_51" data-name="Gruppe 51" transform="translate(0 15.429)">
              <line id="Linie_20" data-name="Linie 20" x1="63.41" transform="translate(0 0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
            </g>
          </g>
        </svg>
      </button>

      <div class="arc-bg" aria-hidden="true"></div>

      <div class="arc-caption">
        {%- if section.settings.heading != blank -%}
          <h2 class="arc-caption__title" style="--caption-color: {{ section.settings.caption_color }}">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}
        {%- if section.settings.text != blank -%}
          <div class="arc-caption__text" style="--caption-color: {{ section.settings.caption_color }}">
            {{ section.settings.text }}
          </div>
        {%- endif -%}
        {%- if section.settings.button_label != blank -%}
          <a class="button" href="{{ section.settings.button_link | default: selected_collection.url }}">
            {{- section.settings.button_label -}}
          </a>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

{% stylesheet %}
  .arc-carousel { position: relative; }
  .arc-carousel__inner.full-width { width: 100%; }
  .arc-carousel__inner.page-width { max-width: var(--normal-page-width); margin-inline: auto; }

  .arc-carousel__stage {
    position: relative;
    min-height: clamp(480px, var(--arc-height, 100vh), 900px);
    display: grid;
    place-items: center;
    padding-bottom: 2rem;
    overflow: hidden;
    height: 80vh;
  }

  .arc-item{
    transition: transform .35s var(--animation-easing, ease-in-out),
               opacity .25s ease;
  }

  /* semicircle background */
  .arc-bg {
    position: absolute;
    height: 100vw;
    border-top-left-radius: 1000%;
    border-top-right-radius: 1000%;
    background: var(--arc-color, #2b98ac);
    z-index: 0;
    box-shadow: inset 0 1px #ffffff40;
    width: 180vw;
    top: 20vw;
   }

  @media (max-width: 749px) {
    .arc-bg { 
      height: min(60vh, 600px);
      top: 35vw;
    }
  }

  @media (min-width: 750px) and (max-width: 999px) {
    .arc-bg {
      height: 80vw;
      top: 32vw;
    }
  }

  /* curved rail */
  .arc-carousel__rail { 
    position: absolute; 
    top: 8%; 
    left: 0; 
    right: 0; 
    pointer-events: none;
   }
  .arc-item {
    position: absolute;
    top: 0;
    width: clamp(140px, 16vw, 220px);
    transform-origin: center bottom;
    will-change: transform, opacity;
    pointer-events: auto;
    text-decoration: none;
  }

  @media (max-width: 749px) {
    .arc-item {
      top: 8vw;
      width: clamp(200px, 50vw, 280px);
    }
  }

  @media (min-width: 750px) and (max-width: 999px) {
    .arc-item {
      top: 5vw;
      width: clamp(160px, 25vw, 240px);
    }
  }

  .arc-card {
    background: #ffffff;
    border-radius: .75rem;
    box-shadow: 0 10px 24px rgb(0 0 0 / .12);
    overflow: hidden;
    border: 1px solid rgb(var(--color-border-rgb, 0 0 0) / .08);
    transition: all 0.5s ease;
   }

  .arc-card:hover{
    transform: translateY(-100px);
  }
  .arc-card__media { 
    aspect-ratio: 3 / 4; background: rgb(0 0 0 / .04); display: grid; place-items: center;
  padding: 20px;
  }
  
  /* Tag-based background colors */
  .arc-card__media--primarstufe {
    background-color: rgba(63, 159, 184, 0.3) !important; /* #3F9FB8 with 30% alpha */
  }
  
  .arc-card__media--sekundarstufe {
    background-color: rgba(227, 6, 19, 0.3) !important; /* #E30613 with 30% alpha */
  }
  
  .arc-card__img { width: 100%; height: 100%; object-fit: cover; }
  .arc-card__meta { padding: .5rem .75rem .75rem; text-align: center; }
  .arc-card__title { font: 600 0.9rem var(--font-body--family, system-ui, sans-serif); line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .arc-card__price { margin-top: .25rem; font: 600 0.9rem var(--font-body--family, system-ui, sans-serif); }

  /* caption area on the semicircle */
  .arc-caption {
    position: absolute;
    z-index: 2;
    width: min(900px, 92%);
    margin-inline: auto;
    text-align: center;
    color: var(--caption-color, #fff);
    display: grid;
    gap: 1rem;
    bottom: 40px;
  }
  .arc-caption__title { color: inherit; margin: 0; font-size: clamp(1.4rem, 3vw, 2.25rem); font-weight: 700; letter-spacing: .02em; }
  .arc-caption__text { color: inherit; opacity: .95; font-size: clamp(.95rem, 1.2vw, 1.125rem); max-width: 60ch; margin-inline: auto; }
  .arc-caption .button { justify-self: center; }

  /* nav buttons */
  .arc-nav {
    position: absolute;
    bottom: 10%;
    transform: translateY(-50%);
    width: 102px;
    height: 102px;
    border-radius: 50%;
    border: 5px solid #E32013;
    background: white;
    box-shadow: var(--shadow-button, 0 2px 6px rgb(0 0 0 / .2));
    display: grid;
    place-items: center;
    font-size: 26px;
    line-height: 1;
    cursor: pointer;
    z-index: 3;
  }

  .arc-nav--prev { 
    left: 12px;

    transform: rotate(-180deg);
   }
  .arc-nav--next {
    right: 12px;
   }

  @media (max-width: 749px) {
    .arc-nav { top: 25%; }
  }

  @media (min-width: 750px) and (max-width: 999px) {
    .arc-nav { top: 35%; }
  }

  @media (min-width: 1000px) {
    .arc-nav { top: 45%; }
  }

  /* responsive */
  @media (max-width: 749px) {
    .arc-caption { margin-top: min(25vh, 200px); }
  }

  @media (min-width: 750px) and (max-width: 999px) {
    .arc-caption { margin-top: min(20vh, 160px); }
  }
{% endstylesheet %}

<script>
  (function () {
    const root = document.getElementById('ArcCarousel-{{ section.id }}');
    if (!root) return;

    const rail = root.querySelector('[data-items]');
    const items = Array.from(rail?.children || []);
    const stage = root.querySelector('.arc-carousel__stage');
    const arcEl = root.querySelector('.arc-bg');
    if (!items.length || !arcEl) return;

    let current = 0;
    const V_DESK = 5; // desktop shows 4 for better spacing
    const V_TAB = 3; // tablet shows 3
    const V_MOB = 1; // mobile shows 1
    const EDGE = 0.7; // Higher value to keep products in valid arc range

    /** point on upper arc (semi-ellipse) for t ∈ [-1, 1] */
    function pointOnArc(t) {
      const arcRect = arcEl.getBoundingClientRect();
      const stageRect = stage.getBoundingClientRect();
      const W = arcRect.width;
      const H = arcRect.height;

      const a = W / 2;
      const b = H * 0.6; // Reduced height factor for less curvature

      // Back to original ellipse formula for arc top edge
      const xRel = t * a * 0.85;
      const yTop = b - b * Math.sqrt(Math.max(0, 1 - (xRel * xRel) / (a * a)));

      const left = arcRect.left - stageRect.left;
      const top = arcRect.top - stageRect.top;

      const x = left + a + xRel;
      const y = top + yTop; // This is the top edge of the blue arc

      return { x, y };
    }

    /** tangent angle on arc (numerical) */
    function angleOnArc(t) {
      const dt = 0.0001;
      const p1 = pointOnArc(Math.max(-1, Math.min(1, t - dt)));
      const p2 = pointOnArc(Math.max(-1, Math.min(1, t + dt)));
      return (Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180) / Math.PI;
    }

    function layout() {
      const isMobile = window.matchMedia('(max-width: 749px)').matches;
      const isTablet = window.matchMedia('(min-width: 750px) and (max-width: 999px)').matches;
      
      let visible;
      if (isMobile) {
        visible = V_MOB;
      } else if (isTablet) {
        visible = V_TAB;
      } else {
        visible = V_DESK;
      }

      // Exact visible window:
      // even -> [-visible/2 .. visible/2 - 1]  e.g. 6 -> [-3..2]
      // odd  -> [-(visible-1)/2 .. (visible-1)/2] e.g. 5 -> [-2..2]
      let minDiff, maxDiff;
      if (visible % 2 === 0) {
        minDiff = -visible / 2;
        maxDiff = visible / 2 - 1;
      } else {
        minDiff = -(visible - 1) / 2;
        maxDiff = (visible - 1) / 2;
      }

      for (let i = 0; i < items.length; i++) {
        const el = items[i];

        // cyclic distance
        let diff = i - current;
        if (diff > items.length / 2) diff -= items.length;
        if (diff < -items.length / 2) diff += items.length;

        if (diff < minDiff || diff > maxDiff) {
          el.style.opacity = 0;
          el.style.pointerEvents = 'none';
          el.style.transform = 'translate(-9999px,-9999px)';
          continue;
        }

        // Map diff → slot 0..visible-1
        const slot = diff - minDiff;
        const tWithin = EDGE + (slot / (visible - 1)) * (1 - 2 * EDGE); // 0..1
        let t = tWithin * 2 - 1; // -1..1
        // clamp to avoid off-arc placements due to rounding
        t = Math.max(-1, Math.min(1, t));

        const { x, y } = pointOnArc(t);
        const angle = angleOnArc(t) * 0.7; // Moderate rotation factor

        const ex = x - el.offsetWidth / 2;
        const ey = y - el.offsetHeight + 20; // Bottom of product sits just above arc edge

        el.style.opacity = 1;
        el.style.pointerEvents = 'auto';
        el.style.transform = `translate(${ex}px, ${ey}px) rotate(${angle}deg)`;
      }
    }

    function next() {
      current = (current + 1) % items.length;
      layout();
    }
    function prev() {
      current = (current - 1 + items.length) % items.length;
      layout();
    }

    root.querySelector('[data-next]')?.addEventListener('click', next);
    root.querySelector('[data-prev]')?.addEventListener('click', prev);
    window.addEventListener('resize', layout);

    // after images load (and fallback)
    const imgs = root.querySelectorAll('img');
    let ready = 0,
      total = imgs.length || 1;
    if (!imgs.length) layout();
    imgs.forEach((img) => {
      if (img.complete) {
        if (++ready >= total) layout();
      } else {
        img.addEventListener('load', () => {
          if (++ready >= total) layout();
        });
      }
    });
    setTimeout(layout, 250);
  })();
</script>

{% schema %}
{
  "name": "Hero Arc Slider",
  "class": "section section--full-width",
  "settings": [
    { "type": "color_scheme", "id": "color_scheme", "label": "t:settings.color_scheme", "default": "scheme-5" },
    {
      "type": "select",
      "id": "section_width",
      "label": "t:settings.width",
      "options": [
        { "value": "page-width", "label": "t:options.page" },
        { "value": "full-width", "label": "t:options.full" }
      ],
      "default": "full-width"
    },
    { "type": "collection", "id": "collection", "label": "Collection" },

    { "type": "header", "content": "Arc appearance" },
    { "type": "color", "id": "arc_color", "label": "Arc color", "default": "#2B98AC" },
    {
      "type": "range",
      "id": "arc_height",
      "label": "Arc height (vh)",
      "min": 30,
      "max": 100,
      "step": 1,
      "default": 55
    },

    { "type": "header", "content": "Caption" },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Wählen Sie Ihre Produkte durch Klick auf die Zeitschrift"
    },
    {
      "type": "textarea",
      "id": "text",
      "label": "Text",
      "default": "Sie wählen eine Zeitschrift und bestellen in Klassenstärke. Die Hefte kommen monatlich (Sept.–Juni) mit Extraheften, Online- und Begleitmaterialien – ohne Aufpreis – direkt an Ihre Schule."
    },
    { "type": "color", "id": "caption_color", "label": "Caption color", "default": "#FFFFFF" },
    { "type": "text", "id": "button_label", "label": "Button label", "default": "Jetzt bestellen" },
    { "type": "url", "id": "button_link", "label": "Button link" }
  ],
  "presets": [{ "name": "Hero Arc Slider", "category": "t:categories.banners" }]
}
{% endschema %}
