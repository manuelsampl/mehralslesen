{% comment %}
  Testimonials section with slider functionality
  Displays customer testimonials with image, text, and subtitle
{% endcomment %}

<div
  id="testimonials-{{ section.id }}"
  class="testimonials"
  style="--padding-block-start: {{ section.settings.padding_top }}px; --padding-block-end: {{ section.settings.padding_bottom }}px;"
>
  <div class="testimonials__background">
    <div class="testimonials__container {{ section.settings.container_width }}">
      <!-- Header -->
      <div class="testimonials__header">
        {% if section.settings.headline != blank %}
          <h2 class="testimonials__headline">{{ section.settings.headline }}</h2>
        {% endif %}
        {% if section.settings.subheadline != blank %}
          <p class="testimonials__subheadline">{{ section.settings.subheadline }}</p>
        {% endif %}
      </div>

      <!-- Testimonials Slider -->
      {% if section.blocks.size > 0 %}
        <div class="testimonials__slider-wrapper">
          <div class="testimonials__slider" data-testimonials-slider>
            <div class="testimonials__slides" data-testimonials-track>
              {% for block in section.blocks %}
                <div 
                  class="testimonials__slide"
                  data-slide="{{ forloop.index0 }}"
                  {{ block.shopify_attributes }}
                >
                  <div class="testimonials__card">
                    {% if block.settings.image != blank %}
                      <div class="testimonials__image">
                        {{
                          block.settings.image
                          | image_url: width: 200, height: 200
                          | image_tag: 
                            alt: block.settings.subtitle,
                            loading: 'lazy',
                            class: 'testimonials__img'
                        }}
                      </div>
                    {% endif %}
                    
                    {% if block.settings.text != blank %}
                      <div class="testimonials__content">
                        <p class="testimonials__text">{{ block.settings.text }}</p>
                      </div>
                    {% endif %}
                    
                    {% if block.settings.subtitle != blank %}
                      <div class="testimonials__meta">
                        <p class="testimonials__subtitle">{{ block.settings.subtitle }}</p>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Navigation Arrows -->
          {% if section.blocks.size > 1 %}
            <div class="testimonials__navigation">
              <button 
                class="testimonials__nav testimonials__nav--prev" 
                type="button" 
                aria-label="{{ 'general.previous' | t | default: 'Previous' }}"
                data-testimonials-prev
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="73.25" height="73.25" viewBox="0 0 73.25 73.25">
                  <g transform="translate(73.25 73.25) rotate(180)">
                    <g fill="#fff" stroke="#e32013" stroke-width="5">
                      <ellipse cx="36.625" cy="36.625" rx="36.625" ry="36.625" stroke="none"/>
                      <ellipse cx="36.625" cy="36.625" rx="34.125" ry="34.125" fill="none"/>
                    </g>
                    <g transform="translate(14.218 25.783)">
                      <g transform="translate(31.963 22.16) rotate(-90)">
                        <line x1="11.08" y2="13.574" transform="translate(11.08)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                        <line x2="11.08" y2="13.574" transform="translate(0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                      </g>
                      <g transform="translate(0 11.08)">
                        <line x1="45.537" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                      </g>
                    </g>
                  </g>
                </svg>
              </button>
              <button 
                class="testimonials__nav testimonials__nav--next" 
                type="button" 
                aria-label="{{ 'general.next' | t | default: 'Next' }}"
                data-testimonials-next
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="73.25" height="73.25" viewBox="0 0 73.25 73.25">
                  <g>
                    <g fill="#fff" stroke="#e32013" stroke-width="5">
                      <ellipse cx="36.625" cy="36.625" rx="36.625" ry="36.625" stroke="none"/>
                      <ellipse cx="36.625" cy="36.625" rx="34.125" ry="34.125" fill="none"/>
                    </g>
                    <g transform="translate(14.218 25.783)">
                      <g transform="translate(31.963 22.16) rotate(-90)">
                        <line x1="11.08" y2="13.574" transform="translate(11.08)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                        <line x2="11.08" y2="13.574" transform="translate(0)" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                      </g>
                      <g transform="translate(0 11.08)">
                        <line x1="45.537" fill="none" stroke="#e32013" stroke-linecap="round" stroke-width="5"/>
                      </g>
                    </g>
                  </g>
                </svg>
              </button>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% stylesheet %}
  .testimonials {
    padding: var(--padding-block-start) 0 var(--padding-block-end);
    overflow: hidden;
  }

  .testimonials__background {
    background: #65b5c4;
    border-radius: 32px 32px 0 0;
    padding: 4rem 0;
    position: relative;
  }

  .testimonials__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .testimonials__container.container--narrow {
    max-width: 900px;
  }

  .testimonials__container.container--full {
    max-width: 100%;
    padding: 0 2rem;
  }

  .testimonials__header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .testimonials__headline {
    font-family: 'Dunant', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 3rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 1rem;
    color: white;
  }

  .testimonials__subheadline {
    font-family: 'Dunant', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 1.125rem;
    font-weight: 400;
    line-height: 1.5;
    margin: 0;
    color: white;
    opacity: 0.9;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    letter-spacing: 0.5px;
  }

  .testimonials__slider-wrapper {
    position: relative;
  }

  .testimonials__slider {
    overflow: hidden;
  }

  .testimonials__slides {
    display: flex;
    transition: transform 0.5s ease;
  }

  .testimonials__slide {
    flex-shrink: 0;
    padding: 0 1rem;
  }

  .testimonials__card {
    background: transparent;
    padding: 2rem;
    text-align: center;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    gap: 1.5rem;
  }

  .testimonials__image {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    margin: 0 auto 1rem;
    border: 3px solid white;
  }

  .testimonials__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .testimonials__content {
    margin-bottom: 1.5rem;
  }

  .testimonials__text {
    font-family: 'Dunant', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 1.25rem;
    line-height: 1.5;
    color: white;
    margin: 0;
    text-align: left;
    max-width: 400px;
  }

  .testimonials__meta {
    margin-top: auto;
  }

  .testimonials__subtitle {
    font-family: 'Dunant', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.9;
  }

  .testimonials__navigation {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    display: flex;
    justify-content: space-between;
    pointer-events: none;
    z-index: 2;
    padding: 0 2rem;
  }

  .testimonials__nav {
    width: 73px;
    height: 73px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    pointer-events: auto;
  }

  .testimonials__nav:hover {
    transform: scale(1.05);
  }

  .testimonials__nav svg {
    width: 100%;
    height: 100%;
  }

  .testimonials__nav--prev {
    margin-left: -40px;
  }

  .testimonials__nav--next {
    margin-right: -40px;
  }

  /* Desktop: Show 2 slides */
  @media screen and (min-width: 769px) {
    .testimonials__slide {
      width: 50%;
    }
  }

  /* Mobile: Show 1 slide */
  @media screen and (max-width: 768px) {
    .testimonials__headline {
      font-size: 2rem;
    }

    .testimonials__subheadline {
      font-size: 1rem;
    }

    .testimonials__background {
      padding: 3rem 0;
      border-radius: 24px 24px 0 0;
    }

    .testimonials__header {
      margin-bottom: 3rem;
    }

    .testimonials__slide {
      width: 100%;
    }

    .testimonials__card {
      padding: 1.5rem;
    }

    .testimonials__image {
      width: 100px;
      height: 100px;
    }

    .testimonials__text {
      font-size: 1.125rem;
    }

    .testimonials__nav {
      width: 60px;
      height: 60px;
    }

    .testimonials__nav--prev {
      margin-left: -30px;
    }

    .testimonials__nav--next {
      margin-right: -30px;
    }

    .testimonials__navigation {
      padding: 0 1rem;
    }
  }
{% endstylesheet %}

{% javascript %}
  class TestimonialsSlider {
    constructor(element) {
      this.slider = element;
      this.track = this.slider.querySelector('[data-testimonials-track]');
      this.slides = this.slider.querySelectorAll('.testimonials__slide');
      this.prevBtn = this.slider.querySelector('[data-testimonials-prev]');
      this.nextBtn = this.slider.querySelector('[data-testimonials-next]');
      
      this.currentIndex = 0;
      this.totalSlides = this.slides.length;
      this.slidesToShow = this.getSlidesToShow();
      
      console.log('Testimonials Slider initialized with', this.totalSlides, 'slides');
      
      this.init();
    }

    getSlidesToShow() {
      return window.innerWidth > 768 ? 2 : 1;
    }

    getMaxIndex() {
      return Math.max(0, this.totalSlides - this.slidesToShow);
    }

    init() {
      if (this.totalSlides <= 1) {
        this.hideNavigation();
        return;
      }
      
      this.bindEvents();
      this.updateSlider();
      
      window.addEventListener('resize', () => {
        this.slidesToShow = this.getSlidesToShow();
        this.currentIndex = Math.min(this.currentIndex, this.getMaxIndex());
        this.updateSlider();
      });
    }

    hideNavigation() {
      if (this.prevBtn) this.prevBtn.style.display = 'none';
      if (this.nextBtn) this.nextBtn.style.display = 'none';
    }

    bindEvents() {
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Previous button clicked');
          this.prevSlide();
        });
      }
      
      if (this.nextBtn) {
        this.nextBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Next button clicked');
          this.nextSlide();
        });
      }

      // Touch events
      this.setupTouchEvents();
    }

    setupTouchEvents() {
      let startX = 0;
      let isDragging = false;

      this.track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        this.track.style.transition = 'none';
      }, { passive: true });

      this.track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        const currentX = e.touches[0].clientX;
        const diff = startX - currentX;
        const slideWidth = this.track.offsetWidth / this.slidesToShow;
        const translateX = -this.currentIndex * slideWidth - diff;
        
        this.track.style.transform = `translateX(${translateX}px)`;
      }, { passive: true });

      this.track.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        this.track.style.transition = 'transform 0.3s ease';
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            this.nextSlide();
          } else {
            this.prevSlide();
          }
        } else {
          this.updateSlider();
        }
        
        isDragging = false;
      }, { passive: true });
    }

    updateSlider() {
      const slideWidth = 100 / this.slidesToShow;
      const translateX = -this.currentIndex * slideWidth;
      this.track.style.transform = `translateX(${translateX}%)`;
      console.log(`Slider updated: currentIndex=${this.currentIndex}, translateX=${translateX}%`);
    }

    nextSlide() {
      const maxIndex = this.getMaxIndex();
      console.log(`Next slide: currentIndex=${this.currentIndex}, maxIndex=${maxIndex}`);
      
      if (this.currentIndex < maxIndex) {
        this.currentIndex++;
      } else {
        this.currentIndex = 0; // Loop back to start
      }
      this.updateSlider();
    }

    prevSlide() {
      const maxIndex = this.getMaxIndex();
      console.log(`Prev slide: currentIndex=${this.currentIndex}, maxIndex=${maxIndex}`);
      
      if (this.currentIndex > 0) {
        this.currentIndex--;
      } else {
        this.currentIndex = maxIndex; // Loop to end
      }
      this.updateSlider();
    }
  }

  // Initialize testimonials sliders
  function initTestimonialsSliders() {
    const sliders = document.querySelectorAll('[data-testimonials-slider]');
    console.log('Found', sliders.length, 'testimonials sliders');
    
    sliders.forEach((slider, index) => {
      if (!slider.sliderInstance) {
        console.log('Initializing slider', index);
        slider.sliderInstance = new TestimonialsSlider(slider);
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTestimonialsSliders);
  } else {
    initTestimonialsSliders();
  }

  // Also try to initialize immediately (for theme editor)
  setTimeout(initTestimonialsSliders, 100);
{% endjavascript %}

{% schema %}
{
  "name": "t:sections.testimonials.name",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "headline",
      "label": "t:sections.testimonials.settings.headline.label",
      "default": "Was Lehrer:innen und Schüler:innen sagen"
    },
    {
      "type": "text",
      "id": "subheadline",
      "label": "t:sections.testimonials.settings.subheadline.label",
      "default": "ERFAHRUNGEN AUS DEM SCHULALLTAG MIT UNSEREN ZEITSCHRIFTEN."
    },
    {
      "type": "select",
      "id": "container_width",
      "label": "t:sections.testimonials.settings.container_width.label",
      "options": [
        {
          "value": "container--narrow",
          "label": "t:sections.testimonials.settings.container_width.options__1.label"
        },
        {
          "value": "container--standard",
          "label": "t:sections.testimonials.settings.container_width.options__2.label"
        },
        {
          "value": "container--full",
          "label": "t:sections.testimonials.settings.container_width.options__3.label"
        }
      ],
      "default": "container--standard"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "t:sections.testimonials.blocks.testimonial.name",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:sections.testimonials.blocks.testimonial.settings.image.label"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "t:sections.testimonials.blocks.testimonial.settings.text.label",
          "default": "Hallo Schule! ist ein idealer Einstieg ins Lesen. Die Kinder lieben die Bildgeschichten – und ich das zusätzliche Material."
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "t:sections.testimonials.blocks.testimonial.settings.subtitle.label",
          "default": "VOLKSSCHULLEHRERIN, NIEDERÖSTERREICH"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.testimonials.presets.name",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "text": "Hallo Schule! ist ein idealer Einstieg ins Lesen. Die Kinder lieben die Bildgeschichten – und ich das zusätzliche Material.",
            "subtitle": "VOLKSSCHULLEHRERIN, NIEDERÖSTERREICH"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "text": "Die Hefte fördern Lesemotivation und bieten perfekt abgestimmte Inhalte zum Lehrplan 2023.",
            "subtitle": "VOLKSSCHULLEHRERIN, STEIERMARK"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "text": "Sir Winston ist cool! Ich kann schon ein bisschen Englisch sagen.",
            "subtitle": "SAMUEL, 9 JAHRE"
          }
        }
      ]
    }
  ]
}
{% endschema %}
